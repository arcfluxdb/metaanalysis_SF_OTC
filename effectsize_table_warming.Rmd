---
title: "table_with_effectsizes"
author: "Sarah"
date: "2024-01-26"
output: html_document
---

## Hallo Jan Hallo Sarah
# set up and load in data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# 30.01.2024

# Sarah

source("data_cleaning.R") # get up-to date dataset

str(working_data)
# 
# #filter treatments we are interested in
# working_data <- full_data %>% 
#   filter(treatment %in% c("CTL","OTC","SNOWFENCE","OTCxSNOWFENCE"))

working_data$month <- month(working_data$flux_date)
working_data$flux_id <- as.factor(paste(working_data$site_id, working_data$year,working_data$c_loss, sep = "_"))

# #working_data$monthseason <- ifelse(working_data$month <= 3,"NGS",
#                                    ifelse(working_data$month <= 5, "Shoulder",
#                                           ifelse(working_data$month <= 9, "GS",
#                                                  ifelse(working_data$month <= 11, "Shoulder", "NGS"))))
```

```{r calculate N, mean and sd}

# Define variables of interest
variables_of_interest <- c("co2")

# Summarize multiple variables
summary_stats <- working_data %>%
  group_by(site_id, year, treatment,flux_id) %>%
  dplyr::summarize_at(vars(variables_of_interest),
                      list(mean = ~mean(., na.rm = TRUE),
                           sd = ~sd(., na.rm = TRUE),
                           n = ~n()))

# Separate data for treatments OTC and SF using filter
ctl <- summary_stats %>% dplyr::filter(treatment == "CTL")
otc <- summary_stats %>% dplyr::filter(treatment == "OTC")
snow_fence <- summary_stats %>% dplyr::filter(treatment == "SNOWFENCE")
snow_fence_otc <- summary_stats %>% dplyr::filter(treatment == "OTCxSNOWFENCE")

effect_df1 <- full_join(otc, snow_fence, by = c("site_id", "year","flux_id"),
                       suffix = c("_otc", "_sf"))

effect_df2 <- full_join(ctl, snow_fence_otc, by = c("site_id", "year","flux_id"),
                       suffix = c("_ctl", "_otc_sf"))

effect_df <- full_join(effect_df1, effect_df2, by = c("site_id", "year","flux_id"),
                       suffix = c("", ""))
```

```{r effectsize calc}
otc_effect_sizes <-
  escalc( # This is the function in metafor that allows us to calculate an effect size for each row in a database
    "SMD",
    # Specify the effect size we want to calculate. In this case SMD for Standardized mean difference
    m1i = mean_otc,
    # mean richness at invaded sites
    n1i = n_otc,
    # invaded site sample size
    sd1i = sd_otc,
    # invaded site SD
    m2i = mean_ctl,
    # mean richness at control sites
    n2i = n_ctl,
    # control site sample size
    sd2i = sd_ctl,
    # control site SD
    data = monthly_otc # This is where the escalc function can find all the data for our meta-analysis
  )

colnames(otc_effect_sizes) <- gsub("yi", "yi_otc",colnames(otc_effect_sizes))
colnames(otc_effect_sizes) <- gsub("vi", "vi_otc",colnames(otc_effect_sizes))

sf_effect_sizes <-
  escalc( # This is the function in metafor that allows us to calculate an effect size for each row in a database
    "SMD",
    # Specify the effect size we want to calculate. In this case SMD for Standardized mean difference
    m1i = mean_sf,
    # mean richness at invaded sites
    n1i = n_sf,
    # invaded site sample size
    sd1i = sd_sf,
    # invaded site SD
    m2i = mean_ctl,
    # mean richness at control sites
    n2i = n_ctl,
    # control site sample size
    sd2i = sd_ctl,
    # control site SD
    data = monthly_sf # This is where the escalc function can find all the data for our meta-analysis
  )

colnames(sf_effect_sizes) <- gsub("yi", "yi_sf",colnames(sf_effect_sizes))
colnames(sf_effect_sizes) <- gsub("vi", "vi_sf",colnames(sf_effect_sizes))

otc_sf_effect_sizes <-
  escalc( # This is the function in metafor that allows us to calculate an effect size for each row in a database
    "SMD",
    # Specify the effect size we want to calculate. In this case SMD for Standardized mean difference
    m1i = mean_otc_sf,
    # mean richness at invaded sites
    n1i = n_otc_sf,
    # invaded site sample size
    sd1i = sd_otc_sf,
    # invaded site SD
    m2i = mean_ctl,
    # mean richness at control sites
    n2i = n_ctl,
    # control site sample size
    sd2i = sd_ctl,
    # control site SD
    data = monthly_otc_sf # This is where the escalc function can find all the data for our meta-analysis
  )

colnames(otc_sf_effect_sizes) <- gsub("yi", "yi_otc_sf",colnames(otc_sf_effect_sizes))
colnames(otc_sf_effect_sizes) <- gsub("vi", "vi_otc_sf",colnames(otc_sf_effect_sizes))
```


```{r}
library(dplyr)

result_table <- working_data %>%
  group_by(site_id, treatment) %>%
  summarize(across(everything(), ~sum(!is.na(.))))

print(result_table)
write.csv(result_table, "data_overview.csv")
```

# run multivariate effects model
#SF
```{r SF}
#total
SF_total <- rma.mv(yi_sf, vi_sf, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=sf_effect_sizes)
summary(SF_total)
forest(SF_total)
predict(SF_total)
#GS
SF_GS <- rma.mv(yi_sf, vi_sf, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(sf_effect_sizes, monthseason=="GS",)
)

forest(SF_GS)
summary(SF_GS)
predict(SF_GS)
#NGS
SF_NGS <- rma.mv(yi_sf, vi_sf,
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(sf_effect_sizes, monthseason=="NGS",)
)
summary(SF_NGS)
predict(SF_NGS)
#Shoulder
SF_sh <- rma.mv(yi_sf, vi_sf, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(sf_effect_sizes, monthseason=="Shoulder",)
)
summary(SF_sh)
forest(SF_sh)
predict(SF_sh)

```

#OTC
```{r  OTC}
#total
OTC_total <- rma.mv(yi_otc, vi_otc, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=otc_effect_sizes)
summary(OTC_total)
forest(OTC_total)
predict(OTC_total)
#GS
OTC_GS <- rma.mv(yi_otc, vi_otc, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_effect_sizes, monthseason=="GS",)
)

forest(OTC_GS)
summary(OTC_GS)
predict(OTC_GS)
#NGS
OTC_NGS <- rma.mv(yi_otc, vi_otc, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_effect_sizes, monthseason=="NGS",)
)
summary(OTC_NGS)
predict(OTC_NGS)
#Shoulder
OTC_sh <- rma.mv(yi_otc, vi_otc, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_effect_sizes, monthseason=="Shoulder",)
)
summary(OTC_sh)
forest(OTC_sh)
predict(OTC_sh)

```

#SFxOTC
```{r SFxOTC}

#total
OTC_SF_total <- rma.mv(yi_otc_sf, vi_otc_sf, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=otc_sf_effect_sizes)
summary(OTC_SF_total)
forest(OTC_SF_total)
predict(OTC_SF_total)
#GS
OTC_SF_GS <- rma.mv(yi_otc_sf, vi_otc_sf,  
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_sf_effect_sizes, monthseason=="GS",)
)

forest(OTC_SF_GS)
summary(OTC_SF_GS)
predict(OTC_SF_GS)
#NGS
OTC_SF_NGS <- rma.mv(yi_otc_sf, vi_otc_sf, 
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_sf_effect_sizes, monthseason=="NGS",)
)
summary(OTC_SF_NGS)
predict(OTC_SF_NGS)
#Shoulder
OTC_SF_sh <- rma.mv(yi_otc_sf, vi_otc_sf,  
                random=list(~ 1 | site_id, 
                            ~ year | site_id), 
                struct="CAR", 
                data=subset(otc_sf_effect_sizes, monthseason=="Shoulder",)
)
summary(OTC_SF_sh)
forest(OTC_SF_sh)
predict(OTC_SF_sh)

```

